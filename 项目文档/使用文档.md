# 使用文档

本项目是一个基于 Python 的本地多模态 AI 智能助手，支持文献的语义搜索与自动分类，以及基于文本描述的图像检索。

## 1. 环境准备

确保已安装依赖并激活环境（如 `exp2`）：
```bash
conda activate exp2
pip install -r requestment.txt
```
**网络特别提示：**
如果在下载模型时遇到网络问题，请在运行命令前设置 Hugging Face 镜像环境变量：
```bash
export HF_ENDPOINT=https://hf-mirror.com&&
```

## 2. 核心功能与命令

所有功能均通过根目录下的 `main.py` 统一调用。

### 测试样例
我已经提前使用setup_test_data.py生成了4张测试图片，分别是红色、蓝色、绿色、黄色。放在了data/images中。并且生成了索引。
生成索引并搜索的测试样例如下。可以看到，正确的结果与其他结果的dis值存在明显差距。
![alt text](image.png)

### 2.1 添加与分类论文 (add_paper)

将新的 PDF 论文添加到系统中，自动提取文本、建立索引，并可选地将其分类移动到对应文件夹。

**命令格式：**
```bash
python main.py add_paper <PDF路径> [选项]
```

**参数说明：**
- `path`: PDF 文件的路径（必填）。
- `--topics`: 预定义的主题列表，用于自动分类（如 "CV,NLP,RL"）。
- `--move`: 如果指定，根据分类结果将文件移动到 `data/papers/<Topic>` 目录下。
- `--no-index`: 如果指定，仅处理文件但不更新向量数据库。

**示例：**
```bash
# 添加论文，自动分类为 CV 或 NLP，并移动文件
python main.py add_paper my_paper.pdf --topics "CV,NLP" --move

# 仅建立索引，不移动文件
python main.py add_paper my_paper.pdf
```

---

### 2.2 搜索论文 (search_paper)

使用自然语言问题搜索已索引的论文。支持返回相关文件列表和具体的文本片段（含页码）。

**命令格式：**
```bash
python main.py search_paper "<查询语句>" [选项]
```

**参数说明：**
- `query`: 搜索问题或关键词（必填）。
- `--top_k`: 返回结果的数量（默认为 5）。
- `--return_snippets`: 是否返回具体的文本片段与页码。
- `--return_files`: 是否返回相关的文件列表（默认为 True）。

**示例：**
```bash
# 搜索关于 Transformer 的论文，返回前 3 个结果
python main.py search_paper "Transformer architecture" --top_k 3

# 搜索并查看具体的文本片段（带页码）
python main.py search_paper "What is attention mechanism?" --return_snippets
```

---

### 2.3 批量整理论文 (batch_organize)

对指定目录下的所有 PDF 文件进行批量扫描、分类、移动和索引。适合整理现有的混乱文件夹。

**命令格式：**
```bash
python main.py batch_organize --root <目录路径> --topics "<主题列表>"
```

**示例：**
```bash
# 整理 data/papers 下的所有 PDF，归类到 CV, NLP, RL 子目录
python main.py batch_organize --root data/papers --topics "CV,NLP,RL"
```

---

### 2.4 建立图像索引 (index_images)

扫描指定目录下的图片文件，使用 CLIP 模型提取特征并建立索引，以便进行“以文搜图”。

**命令格式：**
```bash
python main.py index_images [选项]
```

**参数说明：**
- `--dir`: 指定要索引的图片目录。如果不指定，默认使用配置文件中的 `data/images`。

**示例：**
```bash
# 索引 data/images 下的所有图片
python main.py index_images

# 索引特定目录
python main.py index_images --dir /path/to/my/photos
```

---

### 2.5 以文搜图 (search_image)

使用自然语言描述查找最匹配的本地图片。

**命令格式：**
```bash
python main.py search_image "<描述>" [选项]
```

**参数说明：**
- `query`: 图片内容的文本描述（必填）。
- `--top_k`: 返回结果的数量（默认为 5）。

**示例：**
```bash
# 查找包含红色物体的图片
python main.py search_image "something red"

# 查找海边日落的图片
python main.py search_image "sunset at the beach"
```

## 3. 数据与配置

- **配置文件**: `agent/config.py`
  - 可修改默认模型（如更换更强的 `ViT-L-14`）。
  - 可修改数据存储路径（默认在 `data/` 目录下）。
- **数据目录**:
  - `data/papers`: 存放论文文件。
  - `data/images`: 存放图片文件。
  - `data/index`: 存放 ChromaDB 向量数据库文件。

## 4. 常见问题

- **模型下载慢**: 请务必设置 `export HF_ENDPOINT=https://hf-mirror.com`。
- **显存不足**: 在 `agent/config.py` 中修改 `DEVICE` 为 `"cpu"`，或减小 `batch_size`。
- **权限错误**: 确保对数据目录有读写权限。
