# 项目规划

## 项目框架设计
- 设计原则：高内聚、低耦合、模块化可替换。所有模型与向量库通过统一适配层接入，便于后续升级或更换。
- 分层架构：
  - 接口层：命令行入口 `main.py`，提供 `add_paper`、`search_paper`、`search_image`、`batch_organize` 等子命令。
  - 服务层：`paper_manager`（添加/分类/整理）、`search_service`（文献检索）、`image_search`（以文搜图）、`classifier`（主题分类）、`aggregator`（结果汇总与重排）。
  - 模型层：`text_embedder`（文本嵌入）、`image_embedder`（图像与文本塔嵌入，CLIP）、`llm`（本地 LLM 分类/摘要，可选）、`vision_qa`（视觉描述/问答，可选）。
  - 索引层：`vector_store`（向量库适配器）、`document_index`（文件级与分块级索引）、`image_index`（图片索引）。
  - 解析层：`pdf_parser`（页级解析与分块）、`image_metadata`（图像元数据）。
  - 基础设施：`config`（统一配置与设备管理）、`path`（跨平台路径）、`hashing`（增量索引）、`concurrency`（并发流水线）、`logging`（统一日志与错误处理）。
- 适配器与接口：
  - `VectorStoreAdapter`：默认 `ChromaDB`，可替换 `Qdrant/Milvus/Weaviate`。
  - `Embedder` 接口：统一文本与图像嵌入方法；默认 `sentence-transformers` 与 `open_clip`。
- 索引设计：
  - `papers_files`（文件级）：整篇聚合向量；元数据含 `path/filename/sha256/mtime/topics?`。
  - `papers_chunks`（片段级）：分块向量；元数据含 `path/page_id/chunk_id/char_range`，支持返回片段与页码。
  - `images`：图像向量；元数据含 `path/filename/size/mtime`，支持文本到图像检索。
- CLI 与流程：
  - `add_paper <path> --topics "CV,NLP,RL" --move --index`：解析→分块→嵌入→入库；嵌入式主题分类→移动到子目录。
  - `search_paper "<query>" --top_k 10 --return_snippets --return_files`：片段检索→文件聚合→可选重排；返回文件列表与片段页码。
  - `search_image "<query>" --top_k 10`：文本塔编码→图像索引 Top-K。
  - `batch_organize --root ./data/papers --topics "CV,NLP,RL"`：遍历→增量索引→分类→移动→更新。
- 扩展点：
  - 重排：可插 `bge-reranker-v2` 或其他 CrossEncoder。
  - 视觉增强：`LLaVA/Moondream` 生成图片摘要与标签；扫描件使用 `PaddleOCR` 提升文本可检索性。
  - 本地 LLM：`Ollama` 部署 `Llama-3/Qwen-2` 用于边界样本分类或摘要。


## 项目实现

本项目代码结构清晰，主要分为根目录入口脚本、用户界面模块 (`UI/`) 和核心逻辑模块 (`agent/`)。以下是项目中每个 Python 文件的详细说明：

### 根目录
- **`main.py`**: 项目的命令行入口。负责解析命令行参数（如 `add_paper`, `search_paper`, `search_image`, `batch_organize`），并调用 `agent/services/` 中的相应服务执行具体任务。
- **`setup_test_data.py`**: 用于生成测试数据的脚本（如测试图片），方便快速验证系统功能。
- **`setup_test_data_pdf.py`**: 用于生成测试 PDF 文件的脚本，用于验证文献管理相关功能。

### UI 模块 (`UI/`)
- **`main_ui.py`**: 基于 PyQt6 构建的图形用户界面。
    - 提供了直观的 Tab 页签界面，包括“添加论文”、“搜索论文”、“添加图片”、“以文搜图”和“系统管理”。
    - 负责处理用户交互，调用后端服务，并展示日志和搜索结果（包括图片预览）。
    - 包含多线程处理 (`WorkerThread`) 以防止界面在执行耗时任务时卡顿。

### 核心逻辑模块 (`agent/`)
该模块包含了系统的所有核心业务逻辑，采用分层设计。

#### 1. 配置与工具 (`agent/` & `agent/utils/`)
- **`config.py`**: 系统的全局配置文件。
    - 定义了数据存储路径（如 `DATA_DIR`, `PAPERS_DIR`, `IMAGES_DIR`, `CHROMA_DB_DIR`）。
    - 配置了使用的模型名称（如文本嵌入模型 `all-MiniLM-L6-v2`，图像嵌入模型 `ViT-B-32`）。
    - 包含了设备选择逻辑（CPU/CUDA）。
- **`utils/logging.py`**: 日志配置模块。设置了日志格式和输出级别，确保系统运行时的信息能够被正确记录，便于调试和排错。

#### 2. 服务层 (`agent/services/`)
服务层是对外提供功能的接口，被 `main.py` 和 `UI` 直接调用。
- **`paper_manager.py`**: 文献管理服务。
    - 核心功能：处理论文的添加、分类和整理。
    - `add_paper`: 添加单篇论文，调用解析器提取文本，计算嵌入，存入向量库，并根据关键词或语义进行分类移动。
    - `batch_organize`: 批量整理指定目录下的所有 PDF 文件。
- **`search_service.py`**: 文献检索服务。
    - 核心功能：根据自然语言查询搜索论文。
    - `search_paper`: 将查询文本转换为向量，在向量库中检索相关的论文片段或文件，支持返回文本片段（Snippets）。
- **`image_search.py`**: 图像搜索服务。
    - 核心功能：处理图像索引和以文搜图。
    - `index_images`: 扫描指定目录下的图片，计算 CLIP 嵌入向量并存入向量库。
    - `search_image`: 将查询文本转换为 CLIP 文本向量，在向量库中检索最匹配的图片。

#### 3. 模型层 (`agent/models/`)
封装了底层的深度学习模型调用。
- **`text_embedder.py`**: 文本嵌入模型封装。
    - 使用 `sentence-transformers` 库加载预训练模型。
    - 提供 `embed_texts` 方法，将文本列表转换为向量列表。
- **`image_embedder.py`**: 图像/多模态嵌入模型封装。
    - 使用 `open_clip` 库加载 CLIP 模型。
    - 提供 `embed_images`（图像转向量）和 `embed_text`（文本转向量，用于以文搜图）方法。

#### 4. 索引与存储层 (`agent/index/`)
- **`vector_store.py`**: 向量数据库接口封装。
    - 基于 `ChromaDB` 实现。
    - 管理三个主要的集合（Collections）：
        - `paper_files`: 存储整篇论文的元数据和聚合向量（如有）。
        - `paper_chunks`: 存储论文切片后的文本片段向量，用于细粒度检索。
        - `images`: 存储图片的特征向量。
    - 提供了数据的增删改查（CRUD）接口，如 `add_papers`, `search_paper_chunks`, `add_images`, `search_images`。

#### 5. 解析层 (`agent/parsers/`)
- **`pdf_parser.py`**: PDF 文件解析器。
    - 使用 `PyMuPDF` (fitz) 或其他库提取 PDF 中的文本内容。
    - 负责将长文本切分为适合嵌入的短片段（Chunks），并保留页码等元数据。

## 用到的开源模型介绍
- 文本嵌入（默认）：
  - `sentence-transformers/all-MiniLM-L6-v2`：轻量、速度快、检索质量稳定，适合文件级与分块级索引。
  - 进阶可选：`bge-m3` 或 `gte-large` 提升召回与语义覆盖（视显存与速度权衡）。
- 图像/文本跨模态嵌入（默认）：
  - `open_clip ViT-B/32`：经典 CLIP 模型，兼容文本塔与图像塔，维度 512，适合以文搜图的基础实现。
  - 进阶可选：`open_clip ViT-L/14/laion2b_s32b_b82k`（FP16），更高检索质量；多语言可选 `xlm-roberta-base-ViT-B/32`。
- 重排模型（可选）：
  - `bge-reranker-v2`：CrossEncoder 用于 Top-K 结果重排，提升最终相关性。
- 视觉描述与问答（可选）：
  - `LLaVA`：开源多模态大模型，支持复杂图文对话与描述；可用于生成图片摘要与标签。
  - `Moondream`：轻量 VLM，适合边缘设备与低资源场景的描述/问答。
- 本地 LLM（可选）：
  - `Llama-3`、`Qwen-2`（通过 `Ollama` 部署）：用于主题分类边界样本的二次判断与摘要生成。
- OCR（可选）：
  - `PaddleOCR`：对扫描件 PDF/图像进行文字识别，增强语义检索可用性。

## 有关的开源模型介绍（各种备胎）
- 跨模态匹配模型：
  - `CLIP` 家族（OpenAI 原版与 OpenCLIP 变体）：双塔结构（文本/图像），共享向量空间，实现文本→图像与图像→文本检索。
  - `SigLIP`：改进的文本-图像对齐与检索性能，部分变体在多语言场景表现更好。
  - 多语言 CLIP：如 `xlm-roberta-base-ViT-B/32/laion5b_s13b_b90k`，支持多语种文本检索。
- 视觉语言模型（VLM）：
  - `LLaVA`：对图像进行细粒度理解与对话；适合生成描述、实体、场景标签。
  - `Florence-2`（Microsoft）：轻量视觉模型，支持 OCR、检测与描述，适合图像内容结构化。
  - `Moondream`：小型 VLM，资源占用低，便于本地部署。
  - `Qwen-VL`：多语言视觉-语言模型，图文理解能力强（替代或补充 LLaVA）。
- 文本嵌入模型：
  - `all-MiniLM-L6-v2`（Sbert）：轻量通用基准。
  - `bge` 系列（如 `bge-m3`）：检索效果出色，适合中文与多语言场景。
  - `gte` 系列（如 `gte-large`）：高质量向量表示，提升长文本检索效果。
  - 多语言嵌入：`distiluse-base-multilingual` 等模型覆盖多语种。
- 重排模型：
  - `bge-reranker-v2`：在 Top-K 候选上进行语义匹配打分，常用于最终排序提升。
- OCR 模型：
  - `PaddleOCR`：多语言 OCR 能力强，适合复杂扫描件；`Tesseract` 可作轻量备选。
- 相关生态与框架（用于集成或参考实践）：
  - `ChromaDB`：轻量嵌入式向量库，开箱即用，支持持久化。
  - `Qdrant`/`FAISS`/`Milvus`/`Weaviate`：成熟向量库与 ANN 引擎，适合规模化与过滤查询；支持多集合/过滤条件/压缩存储，方便与多模态索引结合。
  - `clip-retrieval`：CLIP+FAISS 大规模检索后端与 UI，提供端到端嵌入计算、索引构建与可视化查询；适合以文搜图的工程化参考与快速演示。
  - `txtai`：一体化开源语义搜索框架，集成嵌入、索引、搜索与管线编排；快速原型搭建，支持多模型与数据源，适合本地部署。
  - `Haystack`/`LlamaIndex`：多模态检索与 RAG 管线的框架级方案，支持将文本与图像分别入库并统一检索；适合复杂场景与可视化/服务化扩展。
  - `Immich`：高性能自托管相册系统，集成人脸识别、对象识别与基于 CLIP 的上下文搜索；适合作为图像库管理的参考实现。
  - `Paperless-ngx`：开源文档管理，内置 OCR、标签与规则化整理；与语义向量检索组合可构建“自动归档+语义搜索”的混合方案。
  - `Marqo`：多模态向量搜索引擎，开箱即用地进行文本与图像嵌入、存储与检索；支持加权查询与多模型选择，适合快速搭建“以文搜图/以图搜图”服务。
  - `OpenSearch`（Neural Search）：企业级搜索引擎，提供多模态语义搜索接口与管线；适合有现有搜索基础设施的场景，但部署相对偏重。
  - `Open Semantic Search`：开源语义搜索与文本分析平台，集成 OCR、命名实体识别与多源 ETL；适合作为全文检索与知识探索的整体解决方案。
  - `Qdrant examples`：官方示例集合，包含 CLIP 多模态检索与 Notebook 教程；便于学习向量库与图像/文本检索的最佳实践。
  - `bentrevett/clip-search`：使用 OpenCLIP + Faiss + Flask 的文本→图像检索小型演示；适合学习端到端最小可用实现。
  - `jarvisx17/OpenAI-Clip-Image-Search`：基于 Jupyter 的 CLIP + FAISS 检索示例；适合理解向量化、索引与 Top-K 查询流程。
  - `Patrick48777/Image-search-engine`：CLIP + FAISS 的语义图像搜索项目，支持文本与图像相似度检索；包含 Web 端示例与工程结构。
  - `abinthomasonline/clip-faiss`：CLIP + FAISS 的开源演示，突出“文本→图像”最近邻检索流程与应用场景。
 
 - 向量数据库与检索引擎扩展说明：
   - `FAISS`：Facebook 开源的相似度搜索库，支持 IVF/HNSW/PQ 等索引与压缩方案，适合大规模、高性能最近邻检索。
   - `Milvus`：云原生向量数据库，支持海量向量存储与分布式检索，适合生产级部署与多副本容灾。
   - `Weaviate`：支持对象存储与混合检索（向量+符号），具备丰富的过滤与 GraphQL API，适合构建复杂检索应用。
   - `Qdrant`：高性能 ANN 数据库，支持过滤查询、payload 管理与本地嵌入结合，部署简单，社区活跃。
   - `ChromaDB`：嵌入式向量库，适合本地与轻量部署场景；与 Python 生态结合紧密，易于快速集成。
